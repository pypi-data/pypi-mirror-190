#!python
# This file is placed in the Public Domain.


"feeding rss feeds into your irc channel"


import os
import readline
import sys
import termios
import time
import traceback


sys.path.insert(0, os.getcwd())


from rssbot.default import Default
from rssbot.objects import format
from rssbot.storage import Wd


from rssbot.runtime.bus import Bus
from rssbot.runtime.config import Config
from rssbot.runtime.command import Command
from rssbot.runtime.event import Event
from rssbot.runtime.handler import Handler
from rssbot.runtime.scanner import scan
from rssbot.runtime.thread import launch
from rssbot.runtime.utils import privileges, wait
from rssbot.modules import cmd, irc, rss


Cfg = Config()
Wd.workdir = "/var/lib/rssbot/"


scan(cmd)
scan(irc)
scan(rss)


class CLI(Handler):

    @staticmethod
    def announce(txt):
        pass

    @staticmethod
    def raw(txt):
        print(txt)
        sys.stdout.flush()


def waiter():
    got = []
    for ex in Command.errors:
        traceback.print_exception(type(ex), ex, ex.__traceback__)
        got.append(ex)
    for exc in got:
        Command.errors.remove(exc)


def wrap(func):
    fds = sys.stdin.fileno()
    gotterm = True
    try:
        old = termios.tcgetattr(fds)
    except termios.error:
        gotterm = False
    try:
        func()
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        if gotterm:
            termios.tcsetattr(fds, termios.TCSADRAIN, old)
        waiter()


def main():
    Cfg.parse(" ".join(sys.argv[1:]))
    e = Event()
    e.type = "command"
    e.txt = Cfg.otxt
    cli = CLI()
    cli.handle(e)
    e.wait()


wrap(main)

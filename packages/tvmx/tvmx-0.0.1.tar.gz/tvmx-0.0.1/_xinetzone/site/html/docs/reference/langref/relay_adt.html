
<!DOCTYPE html>

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Algebraic Data Types in Relay &#8212; TVM  文档</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/default.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script src="../../../_static/translations.js"></script>
    <script src="../../../_static/design-tabs.js"></script>
    <link rel="icon" href="../../../_static/tvm-logo-square.png"/>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="next" title="Relay Core Tensor Operators" href="relay_op.html" />
    <link rel="prev" title="Relay’s Type System" href="relay_type.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="zh-CN">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
      
      <img src="../../../_static/../../../_static/tvm-logo-small.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">TVM  文档</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../README.html">
   TVM Documentation
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../start.html">
   Getting Started
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../install/index.html">
     Installing TVM
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../install/from_source.html">
       Install from Source
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
      <label for="toctree-checkbox-3">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../install/nnpack.html">
         NNPACK Contrib Installation
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../install/docker.html">
       Docker Images
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../install/nnpack.html">
       NNPACK Contrib Installation
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../contribute/index.html">
     Contributor Guide
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
    <label for="toctree-checkbox-4">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../contribute/community.html">
       TVM Community Guidelines
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../contribute/pull_request.html">
       Submit a Pull Request
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../contribute/code_review.html">
       Code Reviews
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../contribute/committer_guide.html">
       Committer Guide
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../contribute/document.html">
       Documentation
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../contribute/code_guide.html">
       Code Guide and Tips
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../contribute/git_howto.html">
       Git Usage Tips
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../contribute/ci.html">
       Using TVM’s CI
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../contribute/release_process.html">
       Release Process
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../contribute/error_handling.html">
       Error Handling Guide
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../user-guide.html">
   用户手册
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../tutorial/index.html">
     用户指南
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
    <label for="toctree-checkbox-6">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorial/introduction.html">
       TVM 和模型优化的概述
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorial/tvmc_command_line_driver.html">
       用 TVMC 编译和优化模型
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorial/tvmc_python.html">
       开始使用 TVMC Python：TVM 的高级 API
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorial/autotvm_relay_x86.html">
       用 Python 接口编译和优化模型（AutoTVM）
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorial/tensor_expr_get_started.html">
       使用张量表达式处理算子
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorial/autotvm_matmul_x86.html">
       用调度模板和 AutoTVM 优化算子
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorial/auto_scheduler_matmul_x86.html">
       使用自动调度优化运算
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorial/tensor_ir_blitz_course.html">
       TensorIR 的突击课程
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorial/cross_compilation_and_rpc.html">
       交叉编译和RPC
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorial/relay_quick_start.html">
       编译深度学习模型的快速入门教程
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorial/intro_topi.html">
       TOPI 简介
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorial/uma.html">
       通过 UMA 使您的硬件加速器 TVM-ready
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../how_to/index.html">
     How To 指南
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
    <label for="toctree-checkbox-7">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../how_to/compile_models/index.html">
       编译深度学习模型
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
      <label for="toctree-checkbox-8">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/compile_models/from_pytorch.html">
         编译 PyTorch 模型
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/compile_models/from_tensorflow.html">
         Compile Tensorflow Models
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/compile_models/from_mxnet.html">
         编译 MXNet 模型
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/compile_models/from_onnx.html">
         Compile ONNX Models
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/compile_models/from_keras.html">
         Compile Keras Models
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/compile_models/from_tflite.html">
         Compile TFLite Models
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/compile_models/from_coreml.html">
         Compile CoreML Models
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/compile_models/from_darknet.html">
         Compile YOLO-V2 and YOLO-V3 in DarkNet Models
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/compile_models/from_caffe2.html">
         Compile Caffe2 Models
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/compile_models/from_oneflow.html">
         Compile OneFlow Models
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/compile_models/from_paddle.html">
         Compile PaddlePaddle Models
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../how_to/deploy/index.html">
       部署模型并集成到 TVM
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
      <label for="toctree-checkbox-9">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy/cpp_deploy.html">
         使用 C++ API 部署 TVM Module
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy/android.html">
         Deploy to Android
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy/adreno.html">
         Deploy to Adreno GPU
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy/integrate.html">
         集成 TVM 到你的项目
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy/hls.html">
         HLS Backend Example
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy/arm_compute_lib.html">
         集成 Relay Arm
         <sup>
          ®
         </sup>
         计算库
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy/tensorrt.html">
         Relay TensorRT Integration
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy/vitis_ai.html">
         Vitis AI Integration
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy/bnns.html">
         Relay BNNS Integration
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../how_to/deploy_models/index.html">
       部署深度学习模型
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
      <label for="toctree-checkbox-10">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy_models/deploy_model_on_android.html">
         Deploy the Pretrained Model on Android
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy_models/deploy_model_on_rasp.html">
         Deploy the Pretrained Model on Raspberry Pi
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy_models/deploy_object_detection_pytorch.html">
         编译 PyTorch 目标检测模型
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy_models/deploy_prequantized.html">
         使用 TVM 部署框架预量化模型
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy_models/deploy_prequantized_tflite.html">
         Deploy a Framework-prequantized Model with TVM - Part 3 (TFLite)
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy_models/deploy_quantized.html">
         在 CUDA 上部署已量化模型
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy_models/deploy_sparse.html">
         Deploy a Hugging Face Pruned Model on CPU
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/deploy_models/deploy_ssd_gluoncv.html">
         部署 Single Shot Multibox Detector(SSD) 模型
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../how_to/work_with_relay/index.html">
       使用 Relay
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
      <label for="toctree-checkbox-11">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_relay/build_gcn.html">
         构建图卷积网络
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_relay/using_external_lib.html">
         在 Relay 中使用外部库
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_relay/using_pipeline_executor.html">
         在 Relay 中使用管道执行器
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_relay/using_relay_viz.html">
         使用 Relay Visualizer 可视化 Relay
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../how_to/work_with_schedules/index.html">
       使用 Tensor Expression 和 Schedules
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
      <label for="toctree-checkbox-12">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_schedules/schedule_primitives.html">
         TVM 中的调度原语
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_schedules/reduction.html">
         Reduction
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_schedules/intrin_math.html">
         Intrinsics and Math Functions
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_schedules/scan.html">
         Scan and Recurrent Kernel
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_schedules/extern_op.html">
         外部张量函数
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_schedules/tensorize.html">
         Use Tensorize to Leverage Hardware Intrinsics
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_schedules/tuple_inputs.html">
         Compute and Reduce with Tuple Inputs
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_schedules/tedd.html">
         使用 TEDD 进行可视化
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../how_to/optimize_operators/index.html">
       优化张量算子
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
      <label for="toctree-checkbox-13">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/optimize_operators/opt_gemm.html">
         How to optimize GEMM on CPU
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/optimize_operators/opt_conv_cuda.html">
         How to optimize convolution on GPU
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/optimize_operators/opt_conv_tensorcore.html">
         How to optimize convolution using TensorCores
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../how_to/tune_with_autotvm/index.html">
       Auto-Tune with Templates and AutoTVM
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
      <label for="toctree-checkbox-14">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/tune_with_autotvm/tune_conv2d_cuda.html">
         Tuning High Performance Convolution on NVIDIA GPUs
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/tune_with_autotvm/tune_relay_cuda.html">
         Auto-tuning a Convolutional Network for NVIDIA GPU
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/tune_with_autotvm/tune_relay_x86.html">
         Auto-tuning a Convolutional Network for x86 CPU
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/tune_with_autotvm/tune_relay_arm.html">
         Auto-tuning a Convolutional Network for ARM CPU
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/tune_with_autotvm/tune_relay_mobile_gpu.html">
         Auto-tuning a Convolutional Network for Mobile GPU
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../how_to/tune_with_autoscheduler/index.html">
       使用自动调度器进行无模板调度
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
      <label for="toctree-checkbox-15">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/tune_with_autoscheduler/tune_conv2d_layer_cuda.html">
         Auto-scheduling a Convolution Layer for GPU
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/tune_with_autoscheduler/tune_network_x86.html">
         Auto-scheduling a Neural Network for x86 CPU
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/tune_with_autoscheduler/tune_network_cuda.html">
         Auto-scheduling a Neural Network for NVIDIA GPU
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/tune_with_autoscheduler/tune_network_arm.html">
         Auto-scheduling a Neural Network for ARM CPU
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/tune_with_autoscheduler/tune_network_mali.html">
         Auto-scheduling a Neural Network for mali GPU
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/tune_with_autoscheduler/tune_sparse_x86.html">
         Auto-scheduling Sparse Matrix Multiplication on CPU with Custom Sketch Rule
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../how_to/work_with_microtvm/index.html">
       使用 microTVM
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
      <label for="toctree-checkbox-16">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_microtvm/micro_aot.html">
         microTVM Host-Driven AoT
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_microtvm/micro_autotune.html">
         使用 microTVM Autotuning
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_microtvm/micro_ethosu.html">
         在 bare metal Arm® Cortex®-M55 CPU 和 Ethos™-U55 NPU 上运行 TVM
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_microtvm/micro_reference_vm.html">
         microTVM 参考虚拟机
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_microtvm/micro_tflite.html">
         microTVM with TFLite Models
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_microtvm/micro_train.html">
         Training Vision Models for microTVM on Arduino
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/work_with_microtvm/micro_tvmc.html">
         Executing a Tiny Model with TVMC Micro
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../how_to/extend_tvm/index.html">
       拓展 TVM
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
      <label for="toctree-checkbox-17">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/extend_tvm/low_level_custom_pass.html">
         编写定制 Pass
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/extend_tvm/use_pass_infra.html">
         如何使用 TVM Pass Infra
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/extend_tvm/use_pass_instrument.html">
         如何使用 TVM Pass Instrument
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/extend_tvm/bring_your_own_datatypes.html">
         自定义 TVM 数据类型
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../how_to/profile/index.html">
       模型剖析
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/>
      <label for="toctree-checkbox-18">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../how_to/profile/papi.html">
         PAPI 快速上手
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../errors.html">
       Handle TVM Errors
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../faq.html">
       Frequently Asked Questions
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../developer-guide.html">
   Developer Guide
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/>
  <label for="toctree-checkbox-19">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../dev/tutorial/index.html">
     Developer Tutorial
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" type="checkbox"/>
    <label for="toctree-checkbox-20">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../dev/tutorial/codebase_walkthrough.html">
       TVM Codebase Walkthrough by Example
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../dev/how_to/how_to.html">
     Developer How-To Guide
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" type="checkbox"/>
    <label for="toctree-checkbox-21">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../dev/how_to/debugging_tvm.html">
       Debugging TVM
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../dev/how_to/relay_add_op.html">
       Adding an Operator to Relay
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../dev/how_to/relay_add_pass.html">
       Adding a Compiler Pass to Relay
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../dev/how_to/relay_bring_your_own_codegen.html">
       Bring Your Own Codegen To TVM
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../dev/how_to/pytest_target_parametrization.html">
       Python Target Parametrization
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../arch/index.html">
   Design and Architecture
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" type="checkbox"/>
  <label for="toctree-checkbox-22">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/runtime.html">
     TVM Runtime System
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/debugger.html">
     Debugger
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/virtual_machine.html">
     将 VM 放入 TVM：Relay Virtual Machine
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/introduction_to_module_serialization.html">
     模块序列化简介
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/pass_infra.html">
     Pass Infrastructure
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/device_target_interactions.html">
     Device/Target Interactions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/inferbound.html">
     InferBound Pass
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/hybrid_script.html">
     Hybrid Frontend Developer Guide
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/relay_intro.html">
     Relay IR 简介
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/relay_op_strategy.html">
     Relay 算子策略
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/convert_layout.html">
     Convert Layout Pass
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/benchmark.html">
     基准性能日志格式
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/frontend/tensorflow.html">
     TensorFlow Frontend
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/security.html">
     安全指南
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/microtvm_design.html">
     microTVM Design Document
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/microtvm_project_api.html">
     microTVM Project API
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../arch/model_library_format.html">
     Model 库格式
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../topic-guides.html">
   Topic Guides
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" type="checkbox"/>
  <label for="toctree-checkbox-23">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../topic/microtvm/index.html">
     microTVM: TVM on bare-metal
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../topic/vta/index.html">
     VTA: Versatile Tensor Accelerator
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" type="checkbox"/>
    <label for="toctree-checkbox-24">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../topic/vta/install.html">
       VTA Installation Guide
      </a>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../topic/vta/dev/index.html">
       VTA Design and Developer Guide
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" type="checkbox"/>
      <label for="toctree-checkbox-25">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../topic/vta/dev/config.html">
         VTA Configuration
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../topic/vta/dev/hardware.html">
         VTA Hardware Guide
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../topic/vta/tutorials/index.html">
       VTA 教程
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" type="checkbox"/>
      <label for="toctree-checkbox-26">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../topic/vta/tutorials/vta_get_started.html">
         VTA 入门
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../topic/vta/tutorials/matrix_multiply.html">
         简单的矩阵乘法
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../topic/vta/tutorials/frontend/index.html">
         编译深度学习模型
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../topic/vta/tutorials/optimize/index.html">
         优化 Tensor 算子
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../topic/vta/tutorials/autotvm/index.html">
         自动调优
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../../../reference-guide.html">
   Reference Guide
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" type="checkbox"/>
  <label for="toctree-checkbox-27">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="index.html">
     Language Reference
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-28" name="toctree-checkbox-28" type="checkbox"/>
    <label for="toctree-checkbox-28">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="relay_expr.html">
       Expressions in Relay
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="relay_type.html">
       Relay’s Type System
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Algebraic Data Types in Relay
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="relay_op.html">
       Relay Core Tensor Operators
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="relay_pattern.html">
       Pattern Matching in Relay
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="hybrid_script.html">
       Hybrid Frontend Language Reference
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../api/python/index.html">
     Python API
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-29" name="toctree-checkbox-29" type="checkbox"/>
    <label for="toctree-checkbox-29">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/runtime.html">
       tvm.runtime
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/ndarray.html">
       tvm.runtime.ndarray
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/error.html">
       tvm.error
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/ir/module.html">
       tvm.ir.module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/ir/index.html">
       tvm.ir
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/target.html">
       tvm.target
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/tir.html">
       tvm.tir
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/te.html">
       tvm.te
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/driver.html">
       tvm.driver
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/relay/index.html">
       tvm.relay
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/relay/frontend.html">
       tvm.relay.frontend
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/relay/nn.html">
       tvm.relay.nn
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/relay/vision.html">
       tvm.relay.vision
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/relay/image.html">
       tvm.relay.image
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/relay/transform.html">
       tvm.relay.transform
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/relay/analysis.html">
       tvm.relay.analysis
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/relay/backend.html">
       tvm.relay.backend
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/relay/dataflow_pattern.html">
       tvm.relay.dataflow_pattern
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/relay/testing.html">
       tvm.relay.testing
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/autotvm.html">
       tvm.autotvm
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/auto_scheduler.html">
       tvm.auto_scheduler
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/rpc.html">
       tvm.rpc
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/micro.html">
       tvm.micro
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/contrib.html">
       tvm.contrib
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/graph_executor.html">
       tvm.contrib.graph_executor
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/topi.html">
       tvm.topi
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../api/python/vta/index.html">
       vta
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../api/links.html">
     Other APIs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publications.html">
     Publications
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../refs/index.html">
   参考
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-30" name="toctree-checkbox-30" type="checkbox"/>
  <label for="toctree-checkbox-30">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../refs/_ffi/index.html">
     <code class="docutils literal notranslate">
      <span class="pre">
       _ffi
      </span>
     </code>
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-31" name="toctree-checkbox-31" type="checkbox"/>
    <label for="toctree-checkbox-31">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../refs/_ffi/base.html">
       <code class="docutils literal notranslate">
        <span class="pre">
         _ffi.base
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../refs/_ffi/libinfo.html">
       <code class="docutils literal notranslate">
        <span class="pre">
         _ffi.libinfo
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../refs/_ffi/object.html">
       <code class="docutils literal notranslate">
        <span class="pre">
         _ffi._ctypes.object
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../refs/_ffi/registry.html">
       <code class="docutils literal notranslate">
        <span class="pre">
         _ffi.registry
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../refs/_ffi/runtime_ctypes.html">
       <code class="docutils literal notranslate">
        <span class="pre">
         _ffi.runtime_ctypes
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../../_sources/docs/reference/langref/relay_adt.rst.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.rst</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> 导航
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#defining-and-matching-on-an-adt">
   Defining and Matching on an ADT
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#type-checking-adts-and-polymorphism">
   Type-Checking ADTs and Polymorphism
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#recursion-with-adts">
   Recursion with ADTs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pattern-matching-in-match-expressions">
   Pattern Matching in Match Expressions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#common-adt-uses">
   Common ADT Uses
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#implementing-neural-nets-using-adts">
   Implementing Neural Nets Using ADTs
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Algebraic Data Types in Relay</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> 导航 </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#defining-and-matching-on-an-adt">
   Defining and Matching on an ADT
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#type-checking-adts-and-polymorphism">
   Type-Checking ADTs and Polymorphism
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#recursion-with-adts">
   Recursion with ADTs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pattern-matching-in-match-expressions">
   Pattern Matching in Match Expressions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#common-adt-uses">
   Common ADT Uses
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#implementing-neural-nets-using-adts">
   Implementing Neural Nets Using ADTs
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="algebraic-data-types-in-relay">
<span id="adt-overview"></span><h1>Algebraic Data Types in Relay<a class="headerlink" href="#algebraic-data-types-in-relay" title="此标题的永久链接">#</a></h1>
<p>Algebraic data types (ADTs) are a staple feature of functional programming languages,
particularly those derived from ML, because they express data structures in a
manner that is easy to reason about when writing recursive computations.
Because recursion is intended to be one of the primary mechanisms of control
flow in Relay, it is important that Relay include ADTs in order to best express
loops and other control flow structures that must be implemented using recursion.</p>
<section id="defining-and-matching-on-an-adt">
<h2>Defining and Matching on an ADT<a class="headerlink" href="#defining-and-matching-on-an-adt" title="此标题的永久链接">#</a></h2>
<p><em>Note: ADTs are not presently supported in the text format. The syntax here is speculative, based on ADTs in other languages.</em></p>
<p>ADTs can be understood as a generalized version of <code class="code docutils literal notranslate"><span class="pre">enum</span></code> and <code class="code docutils literal notranslate"><span class="pre">struct</span></code> types
from C-like languages. Like a C <code class="code docutils literal notranslate"><span class="pre">struct:</span></code>, an ADT instance is a container for fields
of specified types, but the type system allows for the same type to encode different possible
groupings of fields in a systematic manner, similar to C <code class="code docutils literal notranslate"><span class="pre">enum</span></code> types, which are
defined using a finite set of possible values named by the user.</p>
<p>Specifically, an ADT is defined as a named group of constructors, each of which is
a function that takes values of specified types as arguments and returns an instance
of the named ADT. An ADT instance simply contains the values of the arguments
passed to the constructor call used to produce it.</p>
<p>An ADT value is opaque until it is <em>deconstructed</em>, allowing the arguments to the
constructor to be accessed again and used to compute new values. Because
a particular ADT can have multiple constructors with different signatures,
it is usually necessary to branch on the different possible constructors,
resulting in the <em>match</em> syntax for ADTs. Hence, ADTs are sometimes called
“tagged unions” because an ADT instance is tagged by the name of the constructor
used to produce it and can later be inspected based on the tag.</p>
<p>Because each ADT has a finite set of constructors, it is straightforward to determine
whether a function processing an ADT instance is handling all possible cases.
In particular, the type system can ensure that types are properly assigned in all cases when
deconstructing an ADT instance, in contrast to <code class="code docutils literal notranslate"><span class="pre">union</span></code> types in C.
Hence, it is often easy to reason about ADTs.</p>
<p><em>Implementation detail: Relay ADT definitions are global and are stored in the module, similarly to global function definitions. An ADT name is, in fact, a global type variable (just as a global function name is a global variable). The module keeps a mapping of ADT names (global type variables) to the list of constructors for that ADT.</em></p>
<p>Below is a simple example of defining an ADT and using it in a function
via a match expression:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Defines an ADT named &quot;Numbers&quot;</span>
<span class="n">data</span> <span class="n">Numbers</span> <span class="p">{</span>
  <span class="n">Empty</span> <span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Numbers</span>
  <span class="n">Single</span> <span class="p">:</span> <span class="p">(</span><span class="n">Tensor</span><span class="p">[(),</span> <span class="n">int32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Numbers</span>
  <span class="n">Pair</span> <span class="p">:</span> <span class="p">(</span><span class="n">Tensor</span><span class="p">[(),</span> <span class="n">int32</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">[(),</span> <span class="n">int32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Numbers</span>
<span class="p">}</span>
<span class="c1"># A Numbers value can be produced using an Empty, Single, or Pair</span>
<span class="c1"># constructor, each with a signature given above</span>

<span class="k">def</span> <span class="nd">@sum</span><span class="p">(</span><span class="o">%</span><span class="n">n</span> <span class="p">:</span> <span class="n">Numbers</span><span class="p">[])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">[(),</span> <span class="n">int32</span><span class="p">]</span> <span class="p">{</span>
   <span class="c1"># The match expression branches on the constructor that was</span>
   <span class="c1"># used to produce %n. The variables in each case are bound</span>
   <span class="c1"># if the constructor matches that used for %n</span>
   <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">case</span> <span class="n">Empty</span><span class="p">()</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
     <span class="k">case</span> <span class="n">Single</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="n">x</span> <span class="p">}</span>
     <span class="k">case</span> <span class="n">Pair</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@sum</span><span class="p">(</span><span class="n">Empty</span><span class="p">())</span>    <span class="c1"># evaluates to 0</span>
<span class="nd">@sum</span><span class="p">(</span><span class="n">Single</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  <span class="c1"># evaluates to 3</span>
<span class="nd">@sum</span><span class="p">(</span><span class="n">Pair</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="c1"># evaluates to 11</span>
</pre></div>
</div>
<p>Note that ADTs are identified by name,
meaning that two ADTs with structurally identical constructors
will nevertheless be distinct data types from the point of view of
the typechecker.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># structurally identical constructors to Numbers</span>
<span class="n">data</span> <span class="n">Numbers2</span> <span class="p">{</span>
  <span class="n">Empty2</span> <span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Numbers2</span>
  <span class="n">Single2</span> <span class="p">:</span> <span class="p">(</span><span class="n">Tensor</span><span class="p">[(),</span> <span class="n">int32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Numbers2</span>
  <span class="n">Pair2</span> <span class="p">:</span> <span class="p">(</span><span class="n">Tensor</span><span class="p">[(),</span> <span class="n">int32</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">[(),</span> <span class="n">int32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Numbers2</span>
<span class="p">}</span>

<span class="c1"># the below results in a type error because Numbers2</span>
<span class="c1"># is a distinct type from Numbers</span>
<span class="c1"># fn() { @sum(Empty2()) }</span>
</pre></div>
</div>
</section>
<section id="type-checking-adts-and-polymorphism">
<h2>Type-Checking ADTs and Polymorphism<a class="headerlink" href="#type-checking-adts-and-polymorphism" title="此标题的永久链接">#</a></h2>
<p>This section will go into more specific detail about the typing of ADTs.
Most of the complexity involved results from the fact that, as with functions, ADTs
can be polymorphic and take type parameters.</p>
<p>For example, one of the standard ADTs commonly used in functional
programming languages is the optional type, defined here:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># a is a type parameter</span>
<span class="n">data</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kc">None</span> <span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span>
  <span class="n">Some</span> <span class="p">:</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Optional types are commonly used as the return type for any operation
involving querying into a data structure (returning <code class="code docutils literal notranslate"><span class="pre">Some(v)</span></code>
if a value is found and <code class="code docutils literal notranslate"><span class="pre">None</span></code> if it isn’t).
Taking a type parameter in the definition allows the same optional type
to be used in a wide variety of situations, rather than having to
define a unique ADT for each different type that could be contained in it.</p>
<p>However, it is important to ensure that option types whose contents
are of different types can still be distinguished by the type system,
since it would violate type safety if a function expecting an option
containing a <code class="code docutils literal notranslate"><span class="pre">Tensor[(),</span> <span class="pre">int32]</span></code> instead receives an option
containing a <code class="code docutils literal notranslate"><span class="pre">Tensor[(3,</span> <span class="pre">4),</span> <span class="pre">float32]</span></code>. As this example may
imply, an ADT instance is thus given a type that contains the
concrete type arguments for that instance, ensuring the information is
kept around. Let the below example illustrate:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># the signature for option indicates the type argument</span>
<span class="k">def</span> <span class="nd">@inc_scalar</span><span class="p">(</span><span class="o">%</span><span class="n">opt</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">[(),</span> <span class="n">int32</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">[(),</span> <span class="n">int32</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">case</span> <span class="kc">None</span><span class="p">()</span> <span class="p">{</span> <span class="mi">1</span> <span class="p">}</span>
    <span class="k">case</span> <span class="n">Some</span><span class="p">(</span><span class="o">%</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span> <span class="o">%</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nd">@main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">let</span> <span class="o">%</span><span class="n">one</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">[(),</span> <span class="n">int32</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Some</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">let</span> <span class="o">%</span><span class="n">big</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">float32</span><span class="p">]]</span>
    <span class="o">=</span> <span class="n">Some</span><span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">float32</span><span class="p">));</span>
  <span class="n">let</span> <span class="o">%</span><span class="n">two</span> <span class="o">=</span> <span class="n">inc_scalar</span><span class="p">(</span><span class="o">%</span><span class="n">one</span><span class="p">);</span>
  <span class="c1"># let %bigger = inc_scalar(%big); # type system rejects</span>
  <span class="c1"># None does not take an argument so it can always implicitly</span>
  <span class="c1"># be given the correct type arguments</span>
  <span class="n">let</span> <span class="o">%</span><span class="n">z</span> <span class="o">=</span> <span class="n">inc_scalar</span><span class="p">(</span><span class="kc">None</span><span class="p">());</span>
  <span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The syntax for the annotated type arguments
(e.g., <code class="code docutils literal notranslate"><span class="pre">Optional[Tensor[(),</span> <span class="pre">int32]]</span></code>) in the above examples is
called a “type call,” treating the polymorphic ADT definition as a
type-level function (taking type params and returning a type, namely
the ADT). Any ADT appearing in a type annotation or function signature
must be annotated with type arguments (a non-polymorphic ADT must be
in a type call with no arguments).</p>
<p>Thus, we can say in general that if constructor <code class="code docutils literal notranslate"><span class="pre">C</span></code> that
takes arguments of types <code class="code docutils literal notranslate"><span class="pre">T1,</span> <span class="pre">...,</span> <span class="pre">Tn</span></code> is a constructor
for an ADT <code class="code docutils literal notranslate"><span class="pre">D</span></code> that takes type parameters <code class="code docutils literal notranslate"><span class="pre">v1,</span> <span class="pre">...,</span> <span class="pre">vn</span></code>
(where <code class="code docutils literal notranslate"><span class="pre">T1,</span> <span class="pre">...,</span> <span class="pre">Tn</span></code> may contain any of the <code class="code docutils literal notranslate"><span class="pre">v1,</span> <span class="pre">...,</span> <span class="pre">vn</span></code>),
then <code class="code docutils literal notranslate"><span class="pre">C</span></code> has
the type <code class="code docutils literal notranslate"><span class="pre">fun&lt;v1,</span> <span class="pre">...,</span> <span class="pre">vn&gt;(T1,</span> <span class="pre">...,</span> <span class="pre">Tn)</span> <span class="pre">-&gt;</span> <span class="pre">D[v1,</span> <span class="pre">...,</span> <span class="pre">vn]</span></code>.
This means that constructors are typed like ordinary functions and
thus appear inside call nodes and can be passed to or returned by
other functions. In particular, the <code class="code docutils literal notranslate"><span class="pre">Some</span></code> example above has
the signature <code class="code docutils literal notranslate"><span class="pre">fun&lt;a&gt;(a)</span> <span class="pre">-&gt;</span> <span class="pre">Optional[a]</span></code>, while <code class="code docutils literal notranslate"><span class="pre">None</span></code>
has the signature <code class="code docutils literal notranslate"><span class="pre">fun&lt;a&gt;()</span> <span class="pre">-&gt;</span> <span class="pre">Optional[a]</span></code>.</p>
</section>
<section id="recursion-with-adts">
<h2>Recursion with ADTs<a class="headerlink" href="#recursion-with-adts" title="此标题的永久链接">#</a></h2>
<p>ADT definitions are allowed to be recursive, that is, a definition for
an ADT named <code class="code docutils literal notranslate"><span class="pre">D</span></code> can assume the existence of type <code class="code docutils literal notranslate"><span class="pre">D</span></code> and
use it as an argument to constructors. Recursion allows ADTs to
represent complex structures such as lists or trees; it is the source
of much of ADTs’ power in functional programming, since an appropriately
designed data structure could make it easy to concisely express a
computation with a recursive function.</p>
<p>Many commonly used ADTs involve recursion; some of these are given
in <a class="reference internal" href="#common-adt-uses">Common ADT Uses</a>. As an example here, we will
examine the list ADT, ubiquitous in functional languages:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span> <span class="p">{</span>
   <span class="n">Nil</span> <span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span>
   <span class="n">Cons</span> <span class="p">:</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span>
<span class="p">}</span>
</pre></div>
</div>
<p>(Notice that the recursive reference to <code class="code docutils literal notranslate"><span class="pre">List</span></code> is wrapped
in a type call even in the constructor.)</p>
<p>The above definition means that a list of values of a particular type
can be represented by nesting <code class="code docutils literal notranslate"><span class="pre">Cons</span></code> constructors until the
end of the list is reached, which can be indicated with a <code class="code docutils literal notranslate"><span class="pre">Nil</span></code>
(representing an empty list).</p>
<p>Lists represented in this manner can easily be recursively processed.
For example, the following function sums a list of integers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nd">@list_sum</span><span class="p">(</span><span class="o">%</span><span class="n">l</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tensor</span><span class="p">[(),</span> <span class="n">int32</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">[(),</span> <span class="n">int32</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
    <span class="c1"># add the head of the list to the sum of the tail</span>
    <span class="k">case</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">,</span> <span class="o">%</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="o">%</span><span class="n">h</span> <span class="o">+</span> <span class="nd">@list_sum</span><span class="p">(</span><span class="o">%</span><span class="n">t</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As it happens, many recursive functions on lists like the one just given
share structures that can be factored out into generic, easily
usable functions that will be discussed under <a class="reference internal" href="#common-adt-uses">Common ADT Uses</a>.</p>
</section>
<section id="pattern-matching-in-match-expressions">
<span id="adt-pattern"></span><h2>Pattern Matching in Match Expressions<a class="headerlink" href="#pattern-matching-in-match-expressions" title="此标题的永久链接">#</a></h2>
<p>Match expressions in Relay, as in other functional languages, are capable of
more versatile pattern matching than simply having one case for each constructor
for the datatype of the value being deconstructed.</p>
<p>In particular, the patterns in match cases can be built up recursively:</p>
<ul class="simple">
<li><p>Constructor patterns match for a particular ADT constructor. If a value matches the constructor, each argument to the constructor will be matched against a nested pattern.</p></li>
<li><p>Wildcard patterns will match any value and will not bind to a variable.</p></li>
<li><p>Variable patterns will match any value and bind it to a local variable, scoped to the match clause.</p></li>
</ul>
<p>In the simple case of <code class="code docutils literal notranslate"><span class="pre">&#64;list_sum</span></code> above, the first match case has a <code class="code docutils literal notranslate"><span class="pre">Nil</span></code> constructor pattern (with no nested arguments)
and the second has a <code class="code docutils literal notranslate"><span class="pre">Cons</span></code> constructor pattern that uses variable patterns for each of the arguments to <code class="code docutils literal notranslate"><span class="pre">Cons</span></code>.</p>
<p>The below example uses a wildcard pattern to ignore one of the arguments to <code class="code docutils literal notranslate"><span class="pre">Cons</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nd">@first</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">%</span><span class="n">l</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">{</span> <span class="kc">None</span><span class="p">()</span> <span class="p">}</span>
    <span class="k">case</span><span class="w"> </span><span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">,</span> <span class="k">_</span><span class="p">)</span> <span class="p">{</span> <span class="n">Some</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">)</span> <span class="p">}</span> <span class="c1"># list tail is unused and ignored</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, a constructor pattern is nested inside another constructor pattern to avoid nested match expressions for a list option.
A top-level wildcard pattern is also used to handle all cases that do not match the first clause:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nd">@second_opt</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">%</span><span class="n">ll</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">a</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">ll</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1"># we only need the second member of the list if there is one</span>
    <span class="k">case</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">Cons</span><span class="p">(</span><span class="k">_</span><span class="p">,</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">s</span><span class="p">,</span> <span class="n">_</span><span class="p">)))</span> <span class="p">{</span> <span class="n">Some</span><span class="p">(</span><span class="o">%</span><span class="n">s</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">case</span><span class="w"> </span><span class="k">_</span> <span class="p">{</span> <span class="kc">None</span><span class="p">()</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># @second_opt(Some(Cons(1, Nil()))) evaluates to None()</span>
<span class="c1"># @second_opt(Some(Cons(1, Cons(2, Nil())))) evaluates to Some(2)</span>
<span class="c1"># @second_opt(Some(Nil())) evaluates to None()</span>
<span class="c1"># @second_opt(None()) evaluates to None()</span>
</pre></div>
</div>
<p>Note that a match expression checks its patterns in the order the cases are listed: the first clause whose pattern
that matches the input value is the one that is evaluated. Here, a top-level variable pattern binds the whole
input value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nd">@match_order_beware</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">%</span><span class="n">l</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">%</span><span class="n">v</span> <span class="p">{</span> <span class="o">%</span><span class="n">v</span> <span class="p">}</span>
    <span class="c1"># the above matches everything so neither of these runs</span>
    <span class="k">case</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">,</span> <span class="o">%</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">,</span> <span class="nd">@match_order_beware</span><span class="p">(</span><span class="o">%</span><span class="n">t</span><span class="p">))</span> <span class="p">}</span>
    <span class="k">case</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">{</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="common-adt-uses">
<h2>Common ADT Uses<a class="headerlink" href="#common-adt-uses" title="此标题的永久链接">#</a></h2>
<p>In functional programming languages, certain ADTs provide useful facilities for writing common programs.
Parametric polymorphism and higher-order functions allow these ADTs to be easily reuseable and for generic
functions to manipulate them in common situations. Relay includes a “Prelude” of certain pre-defined ADTs
and functions for them that correspond to the indispensable ADTs of other languages.</p>
<p>The option type defined under <a class="reference internal" href="#type-checking-adts-and-polymorphism">Type-Checking ADTs and Polymorphism</a> is one such ADT, used
whenever it can make sense for a function to only return a value under certain circumstances. Having
the option type allows for the type system to keep track of which functions always return a value
of a certain type versus returning an option of that type, ensuring that any options are always
explicitly checked (contrast with returning null pointers or throwing
exceptions as other ways to addressing that problem).</p>
<p>Lists (defined in <a class="reference internal" href="#recursion-with-adts">Recursion with ADTs</a>) can be manipulated by generic functions in a manner similar to
list comprehensions and certain library functions in Python. Below are very common functions for iterating
through lists, which are included in Relay’s Prelude. (These have all been extensively characterized
in the functional programming literature, and we do not attempt to reproduce that work in this document.)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Map: for [h1, h2, ..., hn] returns [f(h1), f(h2), ..., f(hn)]</span>
<span class="k">def</span> <span class="nd">@map</span><span class="o">&lt;</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">&gt;</span><span class="p">(</span><span class="o">%</span><span class="n">f</span> <span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="p">,</span> <span class="o">%</span><span class="n">l</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">{</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">}</span>
    <span class="k">case</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">,</span> <span class="o">%</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">f</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">),</span> <span class="nd">@map</span><span class="p">(</span><span class="o">%</span><span class="n">f</span><span class="p">,</span> <span class="o">%</span><span class="n">t</span><span class="p">))</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Left fold: for [h1, h2, ..., hn] returns f(...(f(f(z, h1), h2)...), hn)</span>
<span class="k">def</span> <span class="nd">@foldl</span><span class="o">&lt;</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">&gt;</span><span class="p">(</span><span class="o">%</span><span class="n">f</span> <span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="p">,</span> <span class="o">%</span><span class="n">z</span> <span class="p">:</span> <span class="n">b</span><span class="p">,</span> <span class="o">%</span><span class="n">l</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">b</span> <span class="p">{</span>
  <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">{</span> <span class="o">%</span><span class="n">z</span> <span class="p">}</span>
    <span class="k">case</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">,</span> <span class="o">%</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="nd">@foldl</span><span class="p">(</span><span class="o">%</span><span class="n">f</span><span class="p">,</span> <span class="o">%</span><span class="n">f</span><span class="p">(</span><span class="o">%</span><span class="n">z</span><span class="p">,</span> <span class="o">%</span><span class="n">h</span><span class="p">),</span> <span class="o">%</span><span class="n">t</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Right fold: for [h1, h2, ..., hn] returns f(h1, f(h2, f(..., (f(hn, z)...)</span>
<span class="k">def</span> <span class="nd">@foldr</span><span class="o">&lt;</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">&gt;</span><span class="p">(</span><span class="o">%</span><span class="n">f</span> <span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="p">,</span> <span class="o">%</span><span class="n">z</span> <span class="p">:</span> <span class="n">b</span><span class="p">,</span> <span class="o">%</span><span class="n">l</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">b</span> <span class="p">{</span>
  <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">{</span> <span class="o">%</span><span class="n">z</span> <span class="p">}</span>
    <span class="k">case</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">,</span> <span class="o">%</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="o">%</span><span class="n">f</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">,</span> <span class="nd">@foldr</span><span class="p">(</span><span class="o">%</span><span class="n">f</span><span class="p">,</span> <span class="o">%</span><span class="n">z</span><span class="p">,</span> <span class="o">%</span><span class="n">t</span><span class="p">))</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Using these iteration constructs, many common operations over lists can be expressed compactly.
For example, the following map doubles all members of a list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># directly written</span>
<span class="k">def</span> <span class="nd">@double</span><span class="p">(</span><span class="o">%</span><span class="n">l</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tensor</span><span class="p">[(),</span> <span class="n">int32</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tensor</span><span class="p">[(),</span> <span class="n">int32</span><span class="p">]]</span> <span class="p">{</span>
  <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">{</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">}</span>
    <span class="k">case</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">,</span> <span class="o">%</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">h</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="nd">@double</span><span class="p">(</span><span class="o">%</span><span class="n">t</span><span class="p">))</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># map takes care of the recursion</span>
<span class="nd">@map</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="o">%</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span> <span class="o">%</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">},</span> <span class="o">%</span><span class="n">l</span><span class="p">)</span>
</pre></div>
</div>
<p>The following right fold concatenates two lists:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># directly written</span>
<span class="k">def</span> <span class="nd">@concat</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">%</span><span class="n">l1</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="o">%</span><span class="n">l2</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">l1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">{</span> <span class="o">%</span><span class="n">l2</span> <span class="p">}</span>
    <span class="k">case</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">,</span> <span class="o">%</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">,</span> <span class="nd">@concat</span><span class="p">(</span><span class="o">%</span><span class="n">t</span><span class="p">,</span> <span class="o">%</span><span class="n">l2</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># foldr takes care of the recursion</span>
<span class="nd">@foldr</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">,</span> <span class="o">%</span><span class="n">z</span><span class="p">)</span> <span class="p">{</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">,</span> <span class="o">%</span><span class="n">z</span><span class="p">)</span> <span class="p">},</span> <span class="o">%</span><span class="n">l2</span><span class="p">,</span> <span class="o">%</span><span class="n">l1</span><span class="p">)</span>
</pre></div>
</div>
<p>The following left fold flattens a list of lists (using concatenation):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># directly written</span>
<span class="k">def</span> <span class="nd">@flatten</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">%</span><span class="n">ll</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">a</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">ll</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">,</span> <span class="o">%</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="nd">@concat</span><span class="p">(</span><span class="o">%</span><span class="n">h</span><span class="p">,</span> <span class="nd">@flatten</span><span class="p">(</span><span class="o">%</span><span class="n">t</span><span class="p">))</span> <span class="p">}</span>
    <span class="k">case</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">{</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">}</span>
  <span class="p">}</span>

<span class="c1"># foldl takes care of the recursion</span>
<span class="nd">@foldl</span><span class="p">(</span><span class="nd">@concat</span><span class="p">,</span> <span class="n">Nil</span><span class="p">(),</span> <span class="o">%</span><span class="n">ll</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that these iteration constructs can be implemented directly in Relay’s
source language and more can easily be defined (and for more data types, like trees),
rather than being constructs built into the language (e.g.,
<a class="reference external" href="https://mxnet.apache.org/versions/master/tutorials/control_flow/ControlFlowTutorial.html">“foreach” in MXNet</a>).
ADTs and their extensibility allow for a broad range of iterations and data structures to be expressed
in Relay and supported by the type system without having to modify the language implementation.</p>
</section>
<section id="implementing-neural-nets-using-adts">
<h2>Implementing Neural Nets Using ADTs<a class="headerlink" href="#implementing-neural-nets-using-adts" title="此标题的永久链接">#</a></h2>
<p>In <a class="reference external" href="http://colah.github.io/posts/2015-09-NN-Types-FP/">this 2015 blog post</a>, Christopher Olah notes that
many neural networks can be easily expressed using common functional programming constructs. Relay’s ADTs
allow those examples to be implemented directly in TVM.</p>
<p>First let us suppose that we have a function corresponding to a trained recurrent neural net (RNN)
cell, which takes in a past state and an input value and returns a new state and output value. In
Relay, this would have the following signature:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@cell</span> <span class="p">:</span> <span class="n">fn</span><span class="o">&lt;</span><span class="n">state_type</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">state_type</span><span class="p">,</span> <span class="n">in_type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">state_type</span><span class="p">,</span> <span class="n">out_type</span><span class="p">)</span>
</pre></div>
</div>
<p>We might consider a ReLU cell as a simple concrete example, with a trained version below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nd">@linear</span><span class="p">(</span><span class="o">%</span><span class="n">x</span><span class="p">,</span> <span class="o">%</span><span class="n">w</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="o">%</span><span class="n">w</span><span class="o">*%</span><span class="n">x</span> <span class="o">+</span> <span class="o">%</span><span class="n">b</span> <span class="p">}</span>

<span class="k">def</span> <span class="nd">@relu_cell</span><span class="p">(</span><span class="o">%</span><span class="n">w</span><span class="p">,</span> <span class="c1"># weights</span>
               <span class="o">%</span><span class="n">b</span><span class="p">,</span> <span class="c1"># offsets</span>
               <span class="o">%</span><span class="n">s</span><span class="p">,</span> <span class="c1"># state</span>
               <span class="o">%</span><span class="n">x</span>  <span class="c1"># input</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="n">let</span> <span class="o">%</span><span class="n">x2</span> <span class="o">=</span> <span class="nd">@linear</span><span class="p">(</span><span class="o">%</span><span class="n">x</span><span class="p">,</span> <span class="o">%</span><span class="n">w</span><span class="mf">.0</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="mf">.0</span><span class="p">);</span>
  <span class="n">let</span> <span class="o">%</span><span class="n">s2</span> <span class="o">=</span> <span class="nd">@linear</span><span class="p">(</span><span class="o">%</span><span class="n">s</span><span class="p">,</span> <span class="o">%</span><span class="n">w</span><span class="mf">.1</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="mf">.1</span><span class="p">);</span>
  <span class="c1"># doesn&#39;t change the state</span>
  <span class="p">(</span><span class="o">%</span><span class="n">s</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="o">%</span><span class="n">x2</span> <span class="o">+</span> <span class="o">%</span><span class="n">s2</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1"># this is a higher-order function because it returns a closure</span>
<span class="k">def</span> <span class="nd">@trained_cell</span><span class="p">(</span><span class="o">%</span><span class="n">w</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">fn</span><span class="p">(</span><span class="o">%</span><span class="n">x</span><span class="p">,</span> <span class="o">%</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span> <span class="nd">@relu_cell</span><span class="p">(</span><span class="o">%</span><span class="n">w</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span> <span class="o">%</span><span class="n">x</span><span class="p">,</span> <span class="o">%</span><span class="n">h</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Following Olah’s example, we can encode a sequence (list) of inputs with the following left fold:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nd">@encode</span><span class="o">&lt;</span><span class="n">state_type</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_type</span><span class="o">&gt;</span><span class="p">(</span><span class="o">%</span><span class="n">cell</span><span class="p">,</span> <span class="o">%</span><span class="nb">input</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">in_type</span><span class="p">],</span> <span class="o">%</span><span class="n">init</span> <span class="p">:</span> <span class="n">state_type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">state_type</span> <span class="p">{</span>
  <span class="c1"># not using the output</span>
  <span class="nd">@foldl</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="o">%</span><span class="n">state</span><span class="p">,</span> <span class="o">%</span><span class="ow">in</span><span class="p">)</span> <span class="p">{</span> <span class="o">%</span><span class="n">cell</span><span class="p">(</span><span class="o">%</span><span class="n">state</span><span class="p">,</span> <span class="o">%</span><span class="ow">in</span><span class="p">)</span><span class="mf">.0</span> <span class="p">},</span> <span class="o">%</span><span class="n">init</span><span class="p">,</span> <span class="o">%</span><span class="nb">input</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Using an <em>unfold</em> iterator (from Haskell’s standard library), the same cell could be used to make
a generator network (which takes a single input and produces a sequence of outputs):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># included in Relay&#39;s Prelude</span>
<span class="k">def</span> <span class="nd">@unfoldr</span><span class="o">&lt;</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">&gt;</span><span class="p">(</span><span class="o">%</span><span class="n">f</span> <span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)],</span> <span class="o">%</span><span class="n">z</span> <span class="p">:</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">f</span><span class="p">(</span><span class="o">%</span><span class="n">z</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">Some</span><span class="p">(</span><span class="o">%</span><span class="n">pair</span><span class="p">)</span> <span class="p">{</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">pair</span><span class="mf">.0</span><span class="p">,</span> <span class="nd">@unfoldr</span><span class="p">(</span><span class="o">%</span><span class="n">f</span><span class="p">,</span> <span class="o">%</span><span class="n">pair</span><span class="mf">.1</span><span class="p">))</span> <span class="p">}</span>
    <span class="n">case</span> <span class="kc">None</span><span class="p">()</span> <span class="p">{</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># we need some way of generating an input to the cell function given only a state</span>
<span class="k">def</span> <span class="nd">@gen_func</span><span class="o">&lt;</span><span class="n">state_type</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_type</span><span class="o">&gt;</span><span class="p">(</span><span class="o">%</span><span class="n">state</span> <span class="p">:</span> <span class="n">state_type</span><span class="p">)</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[(</span><span class="n">out_type</span><span class="p">,</span> <span class="n">state_type</span><span class="p">)]</span> <span class="p">{</span>
  <span class="n">let</span> <span class="o">%</span><span class="ow">in</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">in_type</span><span class="p">]</span> <span class="o">=</span> <span class="nd">@generate_input</span><span class="p">(</span><span class="o">%</span><span class="n">state</span><span class="p">);</span>
  <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="ow">in</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">Some</span><span class="p">(</span><span class="o">%</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">let</span> <span class="o">%</span><span class="n">cell_out</span> <span class="o">=</span> <span class="nd">@cell</span><span class="p">(</span><span class="o">%</span><span class="n">n</span><span class="p">,</span> <span class="o">%</span><span class="n">state</span><span class="p">);</span>
      <span class="n">Some</span><span class="p">((</span><span class="o">%</span><span class="n">cell_out</span><span class="mf">.1</span><span class="p">,</span> <span class="o">%</span><span class="n">cell_out</span><span class="mf">.0</span><span class="p">))</span> <span class="c1"># pair of output and state</span>
    <span class="p">}</span>
    <span class="n">case</span> <span class="kc">None</span><span class="p">()</span> <span class="p">{</span> <span class="kc">None</span><span class="p">()</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nd">@generator</span><span class="o">&lt;</span><span class="n">state_type</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_type</span><span class="o">&gt;</span><span class="p">(</span><span class="o">%</span><span class="n">cell</span><span class="p">,</span> <span class="o">%</span><span class="n">init</span> <span class="p">:</span> <span class="n">state_type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">out_type</span><span class="p">]</span> <span class="p">{</span>
  <span class="nd">@unfoldr</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="o">%</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span> <span class="nd">@gen_func</span><span class="p">(</span><span class="o">%</span><span class="n">cell</span><span class="p">,</span> <span class="o">%</span><span class="n">state</span><span class="p">)</span> <span class="p">},</span> <span class="o">%</span><span class="n">init</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>An accumulating map (a fold that simultaneously updates an accumulator value and a list
of outputs) can be used to write a general RNN (with an output for every input):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nd">@map_accumr</span><span class="o">&lt;</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">&gt;</span><span class="p">(</span><span class="o">%</span><span class="n">f</span> <span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="o">%</span><span class="n">acc</span> <span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">l</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="p">{</span>
  <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">{</span> <span class="p">(</span><span class="o">%</span><span class="n">acc</span><span class="p">,</span> <span class="n">Nil</span><span class="p">())</span> <span class="p">}</span>
    <span class="k">case</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">b</span><span class="p">,</span> <span class="o">%</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">let</span> <span class="o">%</span><span class="n">update</span> <span class="o">=</span> <span class="o">%</span><span class="n">f</span><span class="p">(</span><span class="o">%</span><span class="n">acc</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="p">);</span>
      <span class="n">let</span> <span class="o">%</span><span class="n">rest</span> <span class="o">=</span> <span class="nd">@map_accumr</span><span class="p">(</span><span class="o">%</span><span class="n">f</span><span class="p">,</span> <span class="o">%</span><span class="n">update</span><span class="mf">.0</span><span class="p">,</span> <span class="o">%</span><span class="n">t</span><span class="p">));</span>
      <span class="p">(</span><span class="o">%</span><span class="n">rest</span><span class="mf">.0</span><span class="p">,</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">update</span><span class="mf">.1</span><span class="p">,</span> <span class="o">%</span><span class="n">rest</span><span class="mf">.1</span><span class="p">))</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># can also be implemented as a right fold</span>
<span class="c1"># (this version is included in Relay&#39;s Prelude)</span>
<span class="k">def</span> <span class="nd">@map_accumr_fold</span><span class="p">(</span><span class="o">%</span><span class="n">f</span><span class="p">,</span> <span class="o">%</span><span class="n">acc</span><span class="p">,</span> <span class="o">%</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
  <span class="nd">@foldr</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="o">%</span><span class="n">b</span><span class="p">,</span> <span class="o">%</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">let</span> <span class="o">%</span><span class="n">f_out</span> <span class="o">=</span> <span class="o">%</span><span class="n">f</span><span class="p">(</span><span class="o">%</span><span class="n">p</span><span class="mf">.0</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="p">);</span>
    <span class="p">(</span><span class="o">%</span><span class="n">f_out</span><span class="mf">.0</span><span class="p">,</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">f_out</span><span class="mf">.1</span><span class="p">,</span> <span class="o">%</span><span class="n">p</span><span class="mf">.1</span><span class="p">))</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="o">%</span><span class="n">acc</span><span class="p">,</span> <span class="n">Nil</span><span class="p">()),</span> <span class="o">%</span><span class="n">l</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nd">@general_rnn</span><span class="o">&lt;</span><span class="n">state_type</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_type</span><span class="o">&gt;</span><span class="p">(</span><span class="o">%</span><span class="n">cell</span><span class="p">,</span> <span class="o">%</span><span class="n">init</span> <span class="p">:</span> <span class="n">state_type</span><span class="p">,</span> <span class="o">%</span><span class="nb">input</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">in_type</span><span class="p">])</span>
  <span class="o">-&gt;</span> <span class="p">(</span><span class="n">state_type</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">out_type</span><span class="p">])</span> <span class="p">{</span>
  <span class="nd">@map_accumr</span><span class="p">(</span><span class="o">%</span><span class="n">cell</span><span class="p">,</span> <span class="o">%</span><span class="n">init</span><span class="p">,</span> <span class="o">%</span><span class="nb">input</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Olah also gives an example of a bidirectional neural network, in which two sets of
cells (which may have different weights) process the input in both directions and produce a
single set of outputs. The following is a Relay implementation of that example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># creates a list of tuples from two lists</span>
<span class="c1"># included in Relay&#39;s Prelude</span>
<span class="k">def</span> <span class="nd">@zip</span><span class="o">&lt;</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">&gt;</span><span class="p">(</span><span class="o">%</span><span class="n">l</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="o">%</span><span class="n">m</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)]</span> <span class="p">{</span>
  <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">{</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">}</span>
    <span class="k">case</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">t1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">match</span><span class="p">(</span><span class="o">%</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">{</span> <span class="n">Nil</span><span class="p">()</span> <span class="p">}</span>
        <span class="k">case</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">b</span><span class="p">,</span> <span class="o">%</span><span class="n">t2</span><span class="p">)</span> <span class="p">{</span> <span class="n">Cons</span><span class="p">((</span><span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="p">),</span> <span class="nd">@zip</span><span class="p">(</span><span class="o">%</span><span class="n">t1</span><span class="p">,</span> <span class="o">%</span><span class="n">t2</span><span class="p">))</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># analogous to map_accumr</span>
<span class="c1"># included in Relay&#39;s Prelude</span>
<span class="k">def</span> <span class="nd">@map_accmul</span><span class="p">(</span><span class="o">%</span><span class="n">f</span><span class="p">,</span> <span class="o">%</span><span class="n">acc</span><span class="p">,</span> <span class="o">%</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
  <span class="nd">@foldl</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="o">%</span><span class="n">p</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="p">){</span>
    <span class="n">let</span> <span class="o">%</span><span class="n">f_out</span> <span class="o">=</span> <span class="o">%</span><span class="n">f</span><span class="p">(</span><span class="o">%</span><span class="n">p</span><span class="mf">.0</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="p">);</span>
    <span class="p">(</span><span class="o">%</span><span class="n">f_out</span><span class="mf">.0</span><span class="p">,</span> <span class="n">Cons</span><span class="p">(</span><span class="o">%</span><span class="n">f_out</span><span class="mf">.1</span><span class="p">,</span> <span class="o">%</span><span class="n">p</span><span class="mf">.1</span><span class="p">))</span>
  <span class="p">},</span> <span class="p">(</span><span class="o">%</span><span class="n">acc</span><span class="p">,</span> <span class="n">Nil</span><span class="p">()),</span> <span class="o">%</span><span class="n">l</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nd">@bidirectional_rnn</span><span class="o">&lt;</span><span class="n">state1_type</span><span class="p">,</span> <span class="n">state2_type</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out1_type</span><span class="p">,</span> <span class="n">out2_type</span><span class="o">&gt;</span>
  <span class="p">(</span><span class="o">%</span><span class="n">cell1</span><span class="p">,</span> <span class="o">%</span><span class="n">cell2</span><span class="p">,</span> <span class="o">%</span><span class="n">state1</span> <span class="p">:</span> <span class="n">state1_type</span><span class="p">,</span> <span class="o">%</span><span class="n">state2</span> <span class="p">:</span> <span class="n">state2_type</span><span class="p">,</span> <span class="o">%</span><span class="nb">input</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">in_type</span><span class="p">])</span>
  <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[(</span><span class="n">out1_type</span><span class="p">,</span> <span class="n">out2_type</span><span class="p">)]</span> <span class="p">{</span>
  <span class="nd">@zip</span><span class="p">(</span><span class="nd">@map_accumr</span><span class="p">(</span><span class="o">%</span><span class="n">cell1</span><span class="p">,</span> <span class="o">%</span><span class="n">state1</span><span class="p">,</span> <span class="o">%</span><span class="nb">input</span><span class="p">)</span><span class="mf">.1</span><span class="p">,</span> <span class="nd">@map_accuml</span><span class="p">(</span><span class="o">%</span><span class="n">cell2</span><span class="p">,</span> <span class="o">%</span><span class="n">state2</span><span class="p">,</span> <span class="o">%</span><span class="nb">input</span><span class="p">)</span><span class="mf">.1</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="relay_type.html" title="上一页 页">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">上一页</p>
            <p class="prev-next-title">Relay’s Type System</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="relay_op.html" title="下一页 页">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">下一页</p>
        <p class="prev-next-title">Relay Core Tensor Operators</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By xinetzone<br/>
  
      &copy; Copyright 2022, xinetzone.<br/>
    Last updated on 2023-02-02, 20:15:57.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>
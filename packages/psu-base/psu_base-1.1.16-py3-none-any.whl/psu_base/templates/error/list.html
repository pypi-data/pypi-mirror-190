{% extends 'psu_base.html' %}
{% load base_taglib %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{%block title%}{%app_name%} - Error List{%endblock%}</title>
</head>
<body>
    {% block pagecontent %}
    <h1>Unexpected Errors</h1>
    <table class="table table-condensed table-striped">
        <tr>
            <th scope="col">Application</th>
            <th scope="col">Date</th>
            <th scope="col">User</th>
            <th scope="col">Technical Details</th>
            <th scope="col">Posted Error</th>
            <th scope="col">System Error</th>
            <th scope="col">Status</th>
        </tr>

        {% for ee in app_errors%}
        <tr>
            <td>{{ee.app_code}}</td>
            <td>{{ee.date_created}}</td>
            <td>
                {{ee.sso_user}}<br />
                {%if ee.impersonated_user %}
                    Impersonating: {{ee.impersonated_user}}<br />
                {%endif%}
                {%if ee.proxied_user %}
                    Proxying: {{ee.proxied_user}}<br />
                {%endif%}
            </td>
            <td class="code" style="font-size: .9em">
                <b>Path:</b> {{ee.path}}<br />
                <b>Parameters:</b> {{ee.parameters}}<br />
                <b>Code:</b> {{ee.code_detail}}<br />
                <b>Browser:</b> <span class="code">{{ee.browser|default:'Unknown'}}</span><br />
            </td>
            <td>{{ee.error_friendly|safe}}</td>
            <td>
                <span class="code" style="font-size: .9em">{{ee.error_system}}</span>
                {%if ee.debug_info%}
                    <div class="code" style="font-size: .9em;color:#555;" title="Additional debugging info">
                        {{ee.debug_info}}
                    </div>
                {%endif%}
            </td>

            <td>
                {%select_menu error_id=ee.id onchange="set_status($(this));" value=ee.status options=status_options %}
            </td>
        </tr>
        {%empty%}
        <tr>
            <td colspan="7">
                <div class="xlg text-success" style="text-align:center">
                    {%fa fa-smile-o%}
                    All errors have been reviewed!
                </div>
            </td>
        </tr>
        {% endfor %}
    </table>

    {%pagination app_errors%}

    <style>
    </style>

    <script type="text/javascript">
        function set_status(menu){
            error_id = menu.attr('error_id');
            new_status = menu.val();
            $.ajax({
                type:   "POST",
                url:    '{%url 'psu:error_status'%}',
                data:   { error_id: error_id, new_status: new_status, csrfmiddlewaretoken: '{{ csrf_token }}' },
                beforeSend:function(){
                    menu.removeClass('ajax-success');
                    menu.removeClass('ajax-error');
                    menu.addClass('ajax-pending');
                    menu.after(getAjaxLoadImage());
                },
                success:function(data){
                    menu.addClass('ajax-success');
                },
                error:function(){
                    menu.addClass('ajax-error');
                },
                complete:function(){
                    menu.removeClass('ajax-pending');
                    clearAjaxLoadImage(menu.parent());
                }
            });
        }
    </script>

    {% endblock %}
</body>
</html>
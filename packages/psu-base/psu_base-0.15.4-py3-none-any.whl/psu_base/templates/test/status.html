{% extends 'psu_base.html' %}
{% load base_taglib %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{%block title%}{{ configs.APP_NAME }} - Status Page{%endblock%}</title>
</head>
<body>
    {% block pagecontent %}
    <table class="table table-condensed table-striped">
        <tr>
            <th align="right">
                Site Name/Code:<br />
                URL:
            </th>
            <td>
                {{ configs.APP_NAME }} ({{ configs.APP_CODE }})<br />
                {%absolute_url%}
            </td>
        </tr>
        <tr>
            <th align="right">Site Version:</th>
            <td>{{ configs.APP_VERSION }}</td>
        </tr>
        <tr>
            <th align="right">Server Time:</th>
            <td>
                Timestamp: {{ server_time.timestamp }}<br />
                Like Banner: {{ server_time.banner_date_time }}<br />
            </td>
        </tr>
        <tr>
            <th align="right">Environment:</th>
            <td>{{ configs.ENVIRONMENT }}</td>
        </tr>
        <tr>
            <th align="right">Debug Mode:</th>
            <td>
                <span class="{%if configs.ENVIRONMENT != 'DEV' and configs.DEBUG%}flagged_issue{%endif%}">
                    {{ configs.DEBUG }}
                </span>
            </td>
        </tr>
        <tr>
            <th align="right">CAS (SSO):</th>
            <td class="{%if 'cas' in issues%}flagged_issue{%endif%}">
                {%if 'cas' in issues%}{%fa fa-exclamation-triangle%}{%endif%}
                {{ cas }}
            </td>
        </tr>
        <tr>
            <th align="right">Finti:</th>
            <td class="{%if 'finti' in issues%}flagged_issue{%endif%}">
                {%if 'finti' in issues%}{%fa fa-exclamation-triangle%}{%endif%}
                {{ finti }}<br />
                {%if configs.FINTI_SIMULATE_CALLS or configs.FINTI_SAVE_RESPONSES%}
                <div class="indent text-danger">
                    {%fa fa-exclamation-triangle%}
                    {%if configs.FINTI_SIMULATE_CALLS or configs.FINTI_SIMULATE_WHEN_POSSIBLE%}
                        <b>
                            Using Simulated Finti Calls
                            {%if configs.FINTI_SIMULATE_WHEN_POSSIBLE%} When Possible{%endif%}
                        </b>
                    {%elif configs.FINTI_SAVE_RESPONSES%}
                        <b>Caching Finti Responses</b>
                    {%endif%}
                </div>
                {%endif%}
            </td>
        </tr>
         <tr>
            <th align="right">SSO Proxy:</th>
            <td>
                <b>HTTP Status:</b> {{ sso_proxy.status }}<br />
                <b>Version:</b> {{ sso_proxy.version }}<br />
                <b>Database:</b>
                    {%if sid%}
                        <span class="{%if 'sid' in issues%}flagged_issue{%endif%}">
                            {%if 'sid' in issues%}{%fa fa-exclamation-triangle%}{%endif%}
                            {{ sid }}
                        </span>
                        <span class="text-muted indented small">
                            Note: This is the database used by the "SSO-Proxy" API.
                            It is not necessarily the database in use for this app.
                        </span><br />
                    {%else%}
                        <span class="{%if 'sid_message' in issues%}flagged_issue{%endif%}">
                            {%if 'sid_message' in issues%}{%fa fa-exclamation-triangle%}{%endif%}
                            {{ sid_message }}
                        </span>
                    {%endif%}
            </td>
        </tr>
        <tr>
            <th align="right">Static Content URL:</th>
            <td>{%static_content_url%}</td>
        </tr>
        <tr>
            <th align="right">Session Duration:</th>
            <td>
                {{session_data.expiry_seconds}} seconds<br />
                <em>{{session_data.expiry_description}} of inactivity</em><br />
            </td>
        </tr>

        {%set_auth_object%}
        {%set_current_user%}
        <tr>
            <th align="right">Identity:</th>
            <td>
                {%if request.user.is_authenticated and auth_object.is_logged_in%}
                    {%id_tag current_user%}<br />
                    <b>{{ configs.APP_NAME }} Authorities:</b><br />
                    <ul>
                        {%for aa in current_user.authorities%}
                            <li>{{aa}}</li>
                        {% empty %}
                            <li>None</li>
                        {%endfor%}
                    </ul>
                    <b>Global Authorities:</b><br />
                    <ul>
                        {%for aa in current_user.global_authorities%}
                            <li>{{aa}}</li>
                        {% empty %}
                            <li>No Global Authorities</li>
                        {%endfor%}
                    </ul>
                {%elif request.user.is_authenticated%}
                    Logged in, but no Banner identity.<br />
                    {{request.session.attributes}}
                {%else%}
                    Not logged in.
                {%endif%}
                <br />
            </td>
        </tr>

        <tr>
            <th>PSU Plugins:</th>
            <td>
                The following PSU re-usable apps have been installed:<br />
                <ul>
                    {%for pp in installed_plugins%}
                        <li>{{pp}}</li>
                    {%endfor%}
                </ul>
            </td>
        </tr>

        <tr>
            <th>Browser:</th>
            <td>
                {{browser}}
            </td>
        </tr>
    </table>

    <h1>TemplateTag Issue:</h1>
    <p class="text-intro">
        For some reason, psu-base template tags with authentication conditions don't work in AWS when not in debug mode.
        This became apparent when authentication checks in the code base did not agree with the same checks made in
        template-tags.  Template tags have been deprecated and replaced by context variables.
        This check should highlight the issue if it also occurs with context variables.
    </p>
    <table class="table table-condensed table-striped table-hover" style="width:auto;">
        <tr>
            <th scope="col"></th>
            <th scope="col">From View</th>
            <th scope="col">From Template-Tag</th>
            <th scope="col">From Context</th>
        </tr>
        <tr>
            <th scope="row">if_logged_in</th>
            <td class="from-view">{{view_auth.if_logged_in}}</td>
            <td class="from-tag">
                Deprecated
            </td>
            <td class="from-context">{{logged_in}}</td>
        </tr>
        <tr>
            <th scope="row">if_can_impersonate</th>
            <td class="from-view">{{view_auth.if_can_impersonate}}</td>
            <td class="from-tag">
                Deprecated
            </td>
            <td class="from-context">{{can_impersonate}}</td>
        </tr>
        <tr>
            <th scope="row">if_impersonating</th>
            <td class="from-view">{{view_auth.if_impersonating}}</td>
            <td class="from-tag">
                Deprecated
            </td>
            <td class="from-context">{{is_impersonating}}</td>
        </tr>
        <tr>
            <th scope="row">if_has_authority_developer</th>
            <td class="from-view">{{view_auth.if_has_authority_developer}}</td>
            <td class="from-tag">
                Deprecated
            </td>
            <td class="from-context">{{is_developer}}</td>
        </tr>
    </table>
    <script type="text/javascript">
        $(document).ready(function(){
            $('.from-context').each(function(){
                var td = $(this);
                var row = td.closest('tr');
                var compare_td = row.find('.from-view');
                if(td.text().trim() !== compare_td.text().trim()){
                    row.addClass('flagged_issue');
                }
                else{
                    td.css('color', 'Green');
                    compare_td.css('color', 'Green');
                }
            });
        });
    </script>

    <style>
        .flagged_issue{
            color: red;
            font-weight: bold;
        }
    </style>

    {% endblock %}
</body>
</html>
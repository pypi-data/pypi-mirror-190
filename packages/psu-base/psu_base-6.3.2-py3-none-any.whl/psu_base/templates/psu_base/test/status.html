{% extends 'psu_base/layout/limited_width.html' %}
{% load base_taglib %}

{%block title%}{%app_name%} - Status Page{%endblock%}

    {% block pagecontent %}
    <table class="table table-condensed table-striped">
        {%if is_development and dev_test_content%}
        <tr>
            <th align="right">
                Development<br />
                Test Content
            </th>
            <td>
                {{ dev_test_content }}
            </td>
        </tr>
        {%endif%}
        <tr>
            <th align="right">
                Site Name/Code:<br />
                URL:
            </th>
            <td>
                {{ configs.APP_NAME }} ({{ configs.APP_CODE }})<br />
                {%absolute_url%}
            </td>
        </tr>
        <tr>
            <th align="right">Site Version:</th>
            <td>{% app_version %}</td>
        </tr>
        <tr>
            <th align="right">Server Time:</th>
            <td>
                Timestamp: {{ server_time.timestamp }}<br />
                Like Banner: {{ server_time.banner_date_time }}<br />
            </td>
        </tr>
        <tr>
            <th align="right">Environment:</th>
            <td>{%setting_value 'ENVIRONMENT' %}</td>
        </tr>
        <tr>
            <th align="right">Next Downtime:</th>
            <td>{{next_downtime}}</td>
        </tr>
        {%if auth.is_logged_in%}
        <tr>
            <th align="right">Debug Mode:</th>
            <td>
                <span class="{%if configs.ENVIRONMENT != 'DEV' and configs.DEBUG%}flagged_issue{%endif%}">
                    {{ configs.DEBUG }}
                </span>
            </td>
        </tr>
        <tr>
            <th align="right">CAS (SSO):</th>
            <td class="{%if 'cas' in issues%}flagged_issue{%endif%}">
                {%if 'cas' in issues%}{%fa fa-exclamation-triangle%}{%endif%}
                {{ cas }}
            </td>
        </tr>
        <tr>
            <th align="right">Finti:</th>
            <td class="{%if 'finti' in issues%}flagged_issue{%endif%}">
                {%if 'finti' in issues%}{%fa fa-exclamation-triangle%}{%endif%}
                {{ finti }}<br />
                {%if configs.FINTI_SIMULATE_CALLS or configs.FINTI_SAVE_RESPONSES%}
                <div class="indent text-danger">
                    {%fa fa-exclamation-triangle%}
                    {%if configs.FINTI_SIMULATE_CALLS or configs.FINTI_SIMULATE_WHEN_POSSIBLE%}
                        <b>
                            Using Simulated Finti Calls
                            {%if configs.FINTI_SIMULATE_WHEN_POSSIBLE%} When Possible{%endif%}
                        </b>
                    {%elif configs.FINTI_SAVE_RESPONSES%}
                        <b>Caching Finti Responses</b>
                    {%endif%}
                </div>
                {%endif%}
            </td>
        </tr>
         <tr>
            <th align="right">SSO Proxy:</th>
            <td>
                <b>HTTP Status:</b> {{ sso_proxy.status }}<br />
                <b>Version:</b> {{ sso_proxy.version }}<br />
                <b>Database:</b>
                    {%if sid%}
                        <span class="{%if 'sid' in issues%}flagged_issue{%endif%}">
                            {%if 'sid' in issues%}{%fa fa-exclamation-triangle%}{%endif%}
                            {{ sid }}
                        </span>
                        <span class="text-muted indented small">
                            Note: This is the database used by the "SSO-Proxy" API.
                            It is not necessarily the database in use for this app.
                        </span><br />
                    {%else%}
                        <span class="{%if 'sid_message' in issues%}flagged_issue{%endif%}">
                            {%if 'sid_message' in issues%}{%fa fa-exclamation-triangle%}{%endif%}
                            {{ sid_message }}
                        </span>
                    {%endif%}
            </td>
        </tr>
        <tr>
            <th align="right">Static Content URL:</th>
            <td>{%static_content_url%}</td>
        </tr>
        <tr>
            <th align="right">Session Duration:</th>
            <td>
                {{session_data.expiry_seconds}} seconds<br />
                <em>{{session_data.expiry_description}} of inactivity</em><br />
            </td>
        </tr>
        {% endif %}

        <tr>
            <th align="right">Identity:</th>
            <td>
                {%if request.user.is_authenticated and auth.is_logged_in%}
                    {%id_tag current_user%}<br />
                    <b>{{ configs.APP_NAME }} Authorities:</b><br />
                    <ul>
                        {%for aa in current_user.authorities%}
                            <li>{{aa}}</li>
                        {% empty %}
                            <li>None</li>
                        {%endfor%}
                    </ul>
                    <b>Global Authorities:</b><br />
                    <ul>
                        {%for aa in current_user.global_authorities%}
                            <li>{{aa}}</li>
                        {% empty %}
                            <li>No Global Authorities</li>
                        {%endfor%}
                    </ul>
                    <b>Roles:</b><br />
                    <ul>
                        {%for aa in current_user.roles%}
                            <li>{{aa}}</li>
                        {% empty %}
                            <li>No Roles</li>
                        {%endfor%}
                    </ul>
                    {%if is_proxying%}
                        {%id_card auth.proxied_user%}<br />
                    {%endif%}

                {%elif request.user.is_authenticated%}
                    Logged in, but no Banner identity.<br />
                    {{request.session.attributes}}
                {%else%}
                    Not logged in.
                {%endif%}
                <br />
            </td>
        </tr>
        {%if auth.is_logged_in%}
        <tr>
            <th>PSU Plugins:</th>
            <td>
                The following PSU re-usable apps have been installed:<br />
                <ul>
                    {%for pp in installed_plugins%}
                        <li>{{pp}}</li>
                    {%endfor%}
                </ul>
            </td>
        </tr>
        {%endif%}
        <tr>
            <th>Browser:</th>
            <td>
                {{browser}}
            </td>
        </tr>
    </table>

    <script type="text/javascript">
        $(document).ready(function(){
            $('.from-context').each(function(){
                var td = $(this);
                var row = td.closest('tr');
                var compare_td = row.find('.from-view');
                if(td.text().trim() !== compare_td.text().trim()){
                    row.addClass('flagged_issue');
                }
                else{
                    td.css('color', 'Green');
                    compare_td.css('color', 'Green');
                }
            });
        });
    </script>

    <style>
        .flagged_issue{
            color: red;
            font-weight: bold;
        }
    </style>

    {% endblock %}
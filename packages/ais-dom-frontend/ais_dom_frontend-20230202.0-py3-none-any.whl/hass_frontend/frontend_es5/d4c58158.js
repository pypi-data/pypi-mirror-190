"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([[87795],{87795:function(e,t,n){n.r(t);var o=n(49097),i=n.n(o);function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function a(e){var t="function"==typeof Map?new Map:void 0;return a=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,o)}function o(){return l(e,arguments,f(this).constructor)}return o.prototype=Object.create(e.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),d(o,e)},a(e)}function l(e,t,n){return l=u()?Reflect.construct.bind():function(e,t,n){var o=[null];o.push.apply(o,t);var i=new(Function.bind.apply(e,o));return n&&d(i,n.prototype),i},l.apply(null,arguments)}function u(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function d(e,t){return d=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},d(e,t)}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}var p=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&d(e,t)}(p,e);var t,n,o,r,a,l=(t=p,n=u(),function(){var e,o=f(t);if(n){var i=f(this).constructor;e=Reflect.construct(o,arguments,i)}else e=o.apply(this,arguments);return c(this,e)});function p(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,p),(e=l.call(this)).attachShadow({mode:"open"}),e}return o=p,(r=[{key:"hass",set:function(e){this.notYetInitialized()?(this.initJsSIPIfNecessary(e),this.initCameraView(e)):this.cameraEntityHasNewAccessToken(e)&&this.updateCameraView(e),this.initDoorbellRinging(e)}},{key:"setConfig",value:function(e){if(!e.camera_entity)throw new Error("You need to define a camera entity");if(!e.sip_settings)throw new Error("You need to define the SIP settings");if(!e.sip_settings.sip_wss_url)throw new Error("You need to define the SIP Secure Webservice url");if(!e.sip_settings.sip_server)throw new Error("You need to define the SIP Server (ip or hostname)");if(!e.sip_settings.sip_username)throw new Error("You need to define the SIP username");if(!e.sip_settings.sip_password)throw new Error("You need to define the SIP password");this.config=e;var t=this.shadowRoot;t.lastChild&&t.removeChild(t.lastChild);var n=document.createElement("ha-card"),o=document.createElement("div"),i=document.createElement("style");i.textContent="\n          ha-card {\n              /* sample css */\n          }\n          .buttons {\n              overflow: auto;\n              padding: 16px;\n              text-align: right;\n          } \n          .ring-buttons {\n              float: left;\n              background: var(--paper-dialog-background-color, var(--primary-background-color));\n              color: var(--paper-dialog-color, var(--primary-text-color));\n          }\n          #cameraview img{\n              object-fit: cover;\n              height: 400px;\n          }\n          mwc-button {\n              margin-right: 16px;\n          }\n          ",o.innerHTML="\n      <div id='cameraview'>\n          <p style=\"padding: 16px\">Initializing SIP connection and webcam view</p>\n          <audio id='audio-player'></audio>\n      </div>\n      <div class='buttons'>\n          <div class=\"ring-buttons\">\n              <mwc-button dense id='bell-everywhere'><ha-icon class=\"mdc-button__icon\" icon=\"mdi:bell-ring-outline\"></ha-icon></mwc-button>\n              <mwc-button dense id='bell-firstfloor'><ha-icon class=\"mdc-button__icon\" icon=\"mdi:bell-outline\"></ha-icon></mwc-button>\n              <mwc-button dense id='bell-off'><ha-icon class=\"mdc-button__icon\" icon=\"mdi:bell-off-outline\"></ha-icon></mwc-button>\n          </div>\n          <mwc-button raised id='btn-open-door'>Otw√≥rz drzwi</mwc-button>\n          <mwc-button style='display:none' raised id='btn-accept-call'>Accept</mwc-button>\n          <mwc-button style='display:none' raised id='btn-reject-call'>Reject</mwc-button>\n          <mwc-button style='display:none' raised id='btn-end-call'>End</mwc-button>\n      </div>\n      ",n.header="",n.appendChild(o),n.appendChild(i),t.appendChild(n)}},{key:"getCardSize",value:function(){return 3}},{key:"notYetInitialized",value:function(){return!this.aisSipDoorRing&&this.config}},{key:"initJsSIPIfNecessary",value:function(e){var t={sockets:[new(i().WebSocketInterface)(this.config.sip_settings.sip_wss_url)],uri:"sip:".concat(this.config.sip_settings.sip_username,"@").concat(this.config.sip_settings.sip_server),authorizationUser:"".concat(this.config.sip_settings.sip_username),register:!0,noAnswerTimeout:60,displayName:"AIS",password:this.config.sip_settings.sip_password};this.aisSipDoorRing=new(i().UA)(t);var n={mediaConstraints:{audio:!0,video:!1}};this.aisSipDoorRing.on("registered",(function(){return console.log("AIS SIP Door Ring registered with SIP Server")})),this.aisSipDoorRing.on("connected",(function(e){console.log("AIS SIP Door Ring connected ")})),this.aisSipDoorRing.on("disconnected",(function(e){console.log("AIS SIP Door Ring disconnected")})),this.aisSipDoorRing.on("unregistered",(function(e){console.log("AIS SIP Door Ring unregistered")})),this.aisSipDoorRing.on("registrationFailed",(function(e){console.log("AIS SIP Door Ring registrationFailed"),console.log("AIS Error: "+e.cause+" "+e.response)})),this.aisSipDoorRing.on("newMessage",(function(e){console.log("AIS SIP Door Ring newMessage"),console.log("AIS Message: "+e)})),this.aisSipDoorRing.on("sipEvent",(function(e){console.log("AIS SIP Door Ring sipEvent"),console.log("AIS Event: "+e)}));var o=this;this.aisSipDoorRing.on("newRTCSession",(function(t){var i=t.session;if("incoming"===i.direction){var r=o.getElementById("btn-accept-call"),s=o.getElementById("btn-reject-call"),c=o.getElementById("btn-end-call");i.on("accepted",(function(){console.log("call accepted"),r.style.display="none",s.style.display="none",c.style.display="inline-flex"})),i.on("confirmed",(function(){return console.log("call confirmed")})),i.on("ended",(function(){console.log("call ended"),o.cleanup(e)})),i.on("failed",(function(){console.log("call failed"),o.cleanup(e)})),i.on("peerconnection",(function(){i.connection.addEventListener("addstream",(function(e){console.log("adding audiostream");var t=document.createElement("audio");t.srcObject=e.stream,t.play()}))})),r.addEventListener("click",(function(){return i.answer(n)})),s.addEventListener("click",(function(){return i.terminate()})),c.addEventListener("click",(function(){return i.terminate()})),r.style.display="inline-flex",s.style.display="inline-flex"}})),this.aisSipDoorRing.start()}},{key:"initCameraView",value:function(e){var t=this;this.cameraViewerShownTimeout=window.setTimeout((function(){return t.isDoorPiNotShown()}),15e3);var n=this.getElementById("cameraview"),o=document.createElement("img"),i=this.config.camera_entity;for(this.access_token=e.states[i].attributes.access_token,o.src="/api/camera_proxy_stream/".concat(i,"?token=").concat(this.access_token),o.style.width="100%";n.firstChild;)n.removeChild(n.firstChild);n.appendChild(o),console.log("initialized camera view")}},{key:"updateCameraView",value:function(e){var t=this.shadowRoot.querySelector("#cameraview img"),n=this.config.camera_entity;this.access_token=e.states[n].attributes.access_token,t.src="/api/camera_proxy_stream/".concat(n,"?token=").concat(this.access_token)}},{key:"cameraEntityHasNewAccessToken",value:function(e){var t=this;return clearTimeout(this.cameraViewerShownTimeout),this.cameraViewerShownTimeout=window.setTimeout((function(){return t.isDoorPiNotShown()}),15e3),!!this.aisSipDoorRing&&this.access_token!==e.states[this.config.camera_entity].attributes.access_token}},{key:"initDoorbellRinging",value:function(e){this.setupBellRingingButton(e,"everywhere","firstfloor"),this.setupBellRingingButton(e,"firstfloor","off"),this.setupBellRingingButton(e,"off","everywhere")}},{key:"setupBellRingingButton",value:function(e,t,n){var o=this.shadowRoot.querySelector("#bell-".concat(t));e.states["input_select.ais_doorbell"].state==="ring-".concat(t)?o.style.display="inline-flex":o.style.display="none",o.addEventListener("click",(function(){return e.callService("input_select","select_option",{entity_id:"input_select.ais_doorbell",option:"ring-".concat(n)})}))}},{key:"isDoorPiNotShown",value:function(){var e=this.shadowRoot.querySelector("#cameraview img");this.isVisible(e)||this.stopCameraStreaming()}},{key:"stopCameraStreaming",value:function(){console.log("Stopping camera stream..."),this.shadowRoot.querySelector("#cameraview img").src="",this.access_token=void 0}},{key:"isVisible",value:function(e){return!(!e||!e.offsetParent&&0===e.offsetWidth&&0===e.offsetHeight)}},{key:"cleanup",value:function(e){var t=this.getElementById("btn-accept-call"),n=this.getElementById("btn-reject-call"),o=this.getElementById("btn-end-call"),i=t.cloneNode(!0);i.style.display="none",t.parentNode.replaceChild(i,t);var r=n.cloneNode(!0);r.style.display="none",n.parentNode.replaceChild(r,n);var s=o.cloneNode(!0);s.style.display="none",o.parentNode.replaceChild(s,o),e.callService("input_boolean","turn_off",{entity_id:"input_boolean.doorbell"})}},{key:"getElementById",value:function(e){return this.shadowRoot.querySelector("#".concat(e))}}])&&s(o.prototype,r),a&&s(o,a),Object.defineProperty(o,"prototype",{writable:!1}),p}(a(HTMLElement));customElements.define("hui-ais-videoring-card",p)}}]);
#!python
# This file is placed in the Public Domain.


import os
import sys
import traceback


sys.path.insert(0, os.getcwd())


from opb import Default, Handler, Storage, privileges, scan, wait


import opb.modules


from opb.modules import cmd, irc, rss


Cfg = Default()
Cfg.name = "opb"


Storage.workdir = "/var/lib/%s/" % Cfg.name


scan(cmd)
scan(rss)


def daemon():
    pid = os.fork()
    if pid != 0:
        os._exit(0)
    os.setsid()
    os.umask(0)
    sis = open("/dev/null", 'r')
    os.dup2(sis.fileno(), sys.stdin.fileno())
    sos = open("/dev/null", 'a+')
    ses = open("/dev/null", 'a+')
    os.dup2(sos.fileno(), sys.stdout.fileno())
    os.dup2(ses.fileno(), sys.stderr.fileno())


def waiter():
    got = []
    for ex in Handler.errors:
        traceback.print_exception(type(ex), ex, ex.__traceback__)
        got.append(ex)
    for exc in got:
        Handler.errors.remove(exc)


def main():
    #daemon()
    privileges(Cfg.name)
    irc.init()
    rss.init()
    wait(waiter)


main()
